<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>üß† –ü–µ—Ä–µ—Å–∫–∞–∑—á–∏–∫</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/html-static/compressor.css">
</head>
<body>

  <main class="main-content">

    <!-- üß© –≠—Ç–∞–ø –≤—ã–±–æ—Ä–∞ -->
    <div id="start-screen">
      <h1>üß† –ü–µ—Ä–µ—Å–∫–∞–∑—á–∏–∫</h1>
      <div class="choice-grid">
        <button onclick="chooseSource('file')" class="choice-tile file" data-icon="üìÅ">
          –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª (.docx / .txt)
        </button>
        <button onclick="chooseSource('text')" class="choice-tile text" data-icon="‚úçÔ∏è">
          –í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é
        </button>
      </div>
    </div>

    <!-- ‚úçÔ∏è –≠—Ç–∞–ø –≤–≤–æ–¥–∞ -->
    <div id="input-screen" style="display:none;">
      <div class="back-button" onclick="goBack()">
        <img src="/static/icons/backto.png" alt="–ù–∞–∑–∞–¥">
      </div>
      <textarea id="text" rows="8" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é..."></textarea>
      <button onclick="compress()">–°–∂–∞—Ç—å —Ç–µ–∫—Å—Ç</button>
    </div>

    <!-- üìÅ –≠—Ç–∞–ø –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div id="upload-screen" style="display:none;">
      <div class="back-button" onclick="goBack()">
        <img src="/static/icons/backto.png" alt="–ù–∞–∑–∞–¥">
      </div>
      <div class="upload-center">
        <div class="upload-icon">üìÅ</div>
        <button id="select-btn" onclick="document.getElementById('file').click()">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</button>
        <input type="file" id="file" accept=".txt,.docx">
        <div id="file-name" class="file-name" style="display:none;"></div>
        <button id="compress-btn" onclick="compress()">–°–∂–∞—Ç—å —Ç–µ–∫—Å—Ç</button>
      </div>
    </div>

    <!-- üìÑ –≠—Ç–∞–ø —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ -->
    <div id="result-screen" style="display:none;">
      <h2>üìÑ –°–æ–∫—Ä–∞—â—ë–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:</h2>
      <div id="output" class="output-text"></div>
      <button id="download-btn">üì• –°–∫–∞—á–∞—Ç—å .docx</button>
      <button onclick="reset()">üîÅ –ï—â—ë —Ä–∞–∑</button>
    </div>

  </main>

  <nav class="bottom-nav">
    <a href="/journal" class="nav-item"><img src="/static/icons/journal.png"><span>–ñ—É—Ä–Ω–∞–ª</span></a>
    <a href="/schedule" class="nav-item"><img src="/static/icons/schedule.png"><span>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</span></a>
    <a href="/student" class="nav-item"><img src="/static/icons/home.png"><span>–ì–ª–∞–≤–Ω–∞—è</span></a>
    <a href="/tools" class="nav-item active"><img src="/static/icons/tools.png"><span>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</span></a>
    <a href="/events" class="nav-item"><img src="/static/icons/news.png"><span>–ù–æ–≤–æ—Å—Ç–∏</span></a>
  </nav>

  <script>
    document.getElementById('file').addEventListener('change', () => {
      const fileInput = document.getElementById('file');
      const fileNameDisplay = document.getElementById('file-name');
      if (fileInput.files.length > 0) {
        fileNameDisplay.textContent = "–í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª: " + fileInput.files[0].name;
        fileNameDisplay.style.display = 'block';
      } else {
        fileNameDisplay.textContent = "";
        fileNameDisplay.style.display = 'none';
      }
    });

    function chooseSource(type) {
      document.getElementById('start-screen').style.display = 'none';
      if (type === 'file') {
        document.getElementById('upload-screen').style.display = 'block';
      } else {
        document.getElementById('input-screen').style.display = 'block';
      }
    }

    function goBack() {
      document.getElementById('upload-screen').style.display = 'none';
      document.getElementById('input-screen').style.display = 'none';
      document.getElementById('start-screen').style.display = 'flex';
    }

    function reset() {
      document.getElementById('result-screen').style.display = 'none';
      document.getElementById('text').value = '';
      document.getElementById('file').value = '';
      document.getElementById('output').innerHTML = '';
      document.getElementById('file-name').style.display = 'none';
      document.getElementById('start-screen').style.display = 'flex';
    }

    async function compress() {
      const text = document.getElementById('text')?.value.trim();
      const fileInput = document.getElementById('file');
      const output = document.getElementById('output');
      const downloadBtn = document.getElementById('download-btn');
      output.innerHTML = '';

      let formData = new FormData();
      formData.append('filename', 'summary');

      if (fileInput && fileInput.files.length > 0) {
        formData.append('file', fileInput.files[0]);
      } else if (text) {
        formData.append('text', text);
      } else {
        alert("‚ùó –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª.");
        return;
      }

      const res = await fetch('/api/compress', {
        method: 'POST',
        body: formData
      });

      const data = await res.json();
      if (data.summary) {
        output.innerHTML = data.summary.map(line => `<p>${line}</p>`).join('');

        document.getElementById('input-screen').style.display = 'none';
        document.getElementById('upload-screen').style.display = 'none';
        document.getElementById('result-screen').style.display = 'block';

        downloadBtn.onclick = () => {
          window.location.href = '/api/download/summary.docx';
        };
      } else {
        alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ç–µ–∫—Å—Ç–∞.");
      }
    }
  </script>

</body>
</html>
